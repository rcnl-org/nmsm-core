% This function is part of the NMSM Pipeline, see file for full license.
%
%
% (Array of double, 2D Matrix of double, 2D Matrix of double, ...
% Array of double) -> (2D Matrix of double)
% Optimize ground contact parameters according to Jackson et al. (2016)

% ----------------------------------------------------------------------- %
% The NMSM Pipeline is a toolkit for model personalization and treatment  %
% optimization of neuromusculoskeletal models through OpenSim. See        %
% nmsm.rice.edu and the NOTICE file for more information. The             %
% NMSM Pipeline is developed at Rice University and supported by the US   %
% National Institutes of Health (R01 EB030520).                           %
%                                                                         %
% Copyright (c) 2021 Rice University and the Authors                      %
% Author(s): Claire V. Hammond                                            %
%                                                                         %
% Licensed under the Apache License, Version 2.0 (the "License");         %
% you may not use this file except in compliance with the License.        %
% You may obtain a copy of the License at                                 %
% http://www.apache.org/licenses/LICENSE-2.0.                             %
%                                                                         %
% Unless required by applicable law or agreed to in writing, software     %
% distributed under the License is distributed on an "AS IS" BASIS,       %
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or         %
% implied. See the License for the specific language governing            %
% permissions and limitations under the License.                          %
% ----------------------------------------------------------------------- %

function forces = calcModeledGroundReactionForce(electricalCenter, ...
    gravity, inertias, masses, jointRotations, jointLocations, ...
    centerOfMasses, jointCoordinates, jointVelocities, jointAccelerations)

ec1                             =  electricalCenter(1);
ec2                             =  electricalCenter(2);
ec3                             =  electricalCenter(3); 
Grav                            =  gravity;
IA1                             =  inertias(1);
IA2                             =  inertias(2);
IA3                             =  inertias(3);
IB1                             =  inertias(4);
IB2                             =  inertias(5);
IB3                             =  inertias(6);
mA                              =  masses(1);
mB                              =  masses(2); 
p1                              =  jointRotations(1);
p2                              =  jointRotations(2);
rx1                             =  jointLocations(1, 1);
rx2                             =  jointLocations(2, 1);
rx3                             =  jointLocations(3, 1);
ry1                             =  jointLocations(1, 2);
ry2                             =  jointLocations(2, 2);
ry3                             =  jointLocations(3, 2);
rz1                             =  jointLocations(1, 3);
rz2                             =  jointLocations(2, 3);
rz3                             =  jointLocations(3, 3);
ux1                             =  centerOfMasses(1, 1);
ux2                             =  centerOfMasses(2, 1);
uy1                             =  centerOfMasses(1, 2);
uy2                             =  centerOfMasses(2, 2);
uz1                             =  centerOfMasses(1, 3);
uz2                             =  centerOfMasses(2, 3);
FGA1                            =  0.0;
FGA2                            =  0.0;
FGA3                            =  0.0;
FGB1                            =  0.0;
FGB2                            =  0.0;
FGB3                            =  0.0;
q1                              =  jointCoordinates(1);
q2                              =  jointCoordinates(2);
q3                              =  jointCoordinates(3);
q4                              =  jointCoordinates(4);
q5                              =  jointCoordinates(5);
q6                              =  jointCoordinates(6);
q7                              =  jointCoordinates(7);
TGA1                            =  0.0;
TGA2                            =  0.0;
TGA3                            =  0.0;
TGB1                            =  0.0;
TGB2                            =  0.0;
TGB3                            =  0.0;
u4                              =  jointVelocities(4);
u5                              =  jointVelocities(5);
u6                              =  jointVelocities(6);
u7                              =  jointVelocities(7);
u1p                             =  jointAccelerations(1);
u2p                             =  jointAccelerations(2);
u3p                             =  jointAccelerations(3);
u4p                             =  jointAccelerations(4);
u5p                             =  jointAccelerations(5);
u6p                             =  jointAccelerations(6);
u7p                             =  jointAccelerations(7);

% Reserve space and initialize matrices
z = zeros(340,1);

% Evaluate constants
z(1) = cos(q4);
z(2) = sin(q4);
z(3) = cos(q5);
z(4) = sin(q5);
z(5) = cos(q6);
z(6) = sin(q6);
z(7) = z(4)*z(6);
z(8) = z(4)*z(5);
z(9) = z(3)*z(6);
z(10) = z(3)*z(5);
z(11) = z(1)*z(5) - z(2)*z(7);
z(12) = z(2)*z(3);
z(13) = z(1)*z(6) + z(2)*z(8);
z(14) = z(1)*z(7) + z(2)*z(5);
z(15) = z(1)*z(3);
z(16) = z(2)*z(6) - z(1)*z(8);
z(17) = cos(p1);
z(18) = sin(p1);
z(19) = cos(p2);
z(20) = sin(p2);
z(21) = z(18)*z(20);
z(22) = z(18)*z(19);
z(23) = z(17)*z(20);
z(24) = z(17)*z(19);
z(25) = cos(q7);
z(26) = sin(q7);
z(27) = z(19)*z(25);
z(28) = z(21)*z(25) - z(17)*z(26);
z(29) = -z(18)*z(26) - z(23)*z(25);
z(30) = z(19)*z(26);
z(31) = z(17)*z(25) + z(21)*z(26);
z(32) = z(18)*z(25) - z(23)*z(26);
z(33) = z(20)^2;
z(34) = z(33) + z(19)*z(27);
z(35) = z(20)*z(22);
z(36) = z(19)*z(28) - z(35);
z(37) = z(20)*z(24);
z(38) = z(37) + z(19)*z(29);
z(39) = z(17)*z(30) + z(21)*z(27) - z(35);
z(40) = z(22)^2;
z(41) = z(40) + z(17)*z(31) + z(21)*z(28);
z(42) = z(22)*z(24);
z(43) = z(17)*z(32) + z(21)*z(29) - z(42);
z(44) = z(37) + z(18)*z(30) - z(23)*z(27);
z(45) = z(18)*z(31) - z(42) - z(23)*z(28);
z(46) = z(24)^2;
z(47) = z(46) + z(18)*z(32) - z(23)*z(29);
z(48) = z(11)*z(34) + z(13)*z(44) - z(12)*z(39);
z(49) = z(11)*z(36) + z(13)*z(45) - z(12)*z(41);
z(50) = z(11)*z(38) + z(13)*z(47) - z(12)*z(43);
z(51) = z(14)*z(34) + z(15)*z(39) + z(16)*z(44);
z(52) = z(14)*z(36) + z(15)*z(41) + z(16)*z(45);
z(53) = z(14)*z(38) + z(15)*z(43) + z(16)*z(47);
z(54) = z(4)*z(39) + z(10)*z(44) - z(9)*z(34);
z(55) = z(4)*z(41) + z(10)*z(45) - z(9)*z(36);
z(56) = z(4)*z(43) + z(10)*z(47) - z(9)*z(38);
z(57) = z(5)*z(34) + z(6)*z(44);
z(58) = z(5)*z(36) + z(6)*z(45);
z(59) = z(5)*z(38) + z(6)*z(47);
z(60) = z(5)*u5 - z(9)*u4;
z(61) = u6 + z(4)*u4;
z(62) = z(6)*u5 + z(10)*u4;
z(63) = z(3)*z(5)*u6 - z(4)*z(6)*u5;
z(64) = -z(6)*u5*u6 - u4*z(63);
z(65) = z(3)*u4*u5;
z(66) = -z(3)*z(6)*u6 - z(4)*z(5)*u5;
z(67) = z(5)*u5*u6 + u4*z(66);
z(68) = z(20)*u7 + z(39)*u6 + z(54)*u4 + z(57)*u5;
z(69) = z(41)*u6 + z(55)*u4 + z(58)*u5 - z(22)*u7;
z(70) = z(24)*u7 + z(43)*u6 + z(56)*u4 + z(59)*u5;
z(71) = z(19)*z(25)*u7;
z(72) = z(19)*z(26)*u7;
z(73) = z(17)*z(71) - z(21)*z(72);
z(74) = z(18)*z(71) + z(23)*z(72);
z(75) = z(3)*z(39)*u5 + z(4)*z(73) + z(10)*z(74) + z(44)*z(66) + z(19)*z(9)*z(72) - z(34)*z(63);
z(76) = z(5)*z(44)*u6 + z(6)*z(74) - z(6)*z(34)*u6 - z(19)*z(5)*z(72);
z(77) = u4*z(75) + u5*z(76) + u6*z(73);
z(78) = (z(17)*z(26)-z(21)*z(25))*u7;
z(79) = (z(17)*z(25)+z(21)*z(26))*u7;
z(80) = -z(17)*z(78) - z(21)*z(79);
z(81) = z(23)*z(79) - z(18)*z(78);
z(82) = z(3)*z(41)*u5 + z(4)*z(80) + z(10)*z(81) + z(45)*z(66) + z(19)*z(9)*z(79) - z(36)*z(63);
z(83) = z(5)*z(45)*u6 + z(6)*z(81) - z(6)*z(36)*u6 - z(19)*z(5)*z(79);
z(84) = u4*z(82) + u5*z(83) + u6*z(80);
z(85) = (z(18)*z(26)+z(23)*z(25))*u7;
z(86) = (z(18)*z(25)-z(23)*z(26))*u7;
z(87) = -z(17)*z(85) - z(21)*z(86);
z(88) = z(23)*z(86) - z(18)*z(85);
z(89) = z(3)*z(43)*u5 + z(4)*z(87) + z(10)*z(88) + z(47)*z(66) + z(19)*z(9)*z(86) - z(38)*z(63);
z(90) = z(5)*z(47)*u6 + z(6)*z(88) - z(6)*z(38)*u6 - z(19)*z(5)*z(86);
z(91) = u4*z(89) + u5*z(90) + u6*z(87);
z(92) = uy1*z(5);
z(93) = -ux1*z(4) - uy1*z(9);
z(94) = ux1*z(6) - uz1*z(5);
z(95) = ux1*z(10) + uz1*z(9);
z(96) = uz1*z(4) - uy1*z(10);
z(97) = uy1*z(6);
z(98) = ry1*z(5);
z(99) = -rx1*z(4) - ry1*z(9);
z(100) = rx1*z(6) - rz1*z(5);
z(101) = rx1*z(10) + rz1*z(9);
z(102) = rz1*z(4) - ry1*z(10);
z(103) = ry1*z(6);
z(104) = ry2*z(5);
z(105) = -rx2*z(4) - ry2*z(9);
z(106) = rx2*z(6) - rz2*z(5);
z(107) = rx2*z(10) + rz2*z(9);
z(108) = rz2*z(4) - ry2*z(10);
z(109) = ry2*z(6);
z(110) = ux2 - rx3;
z(111) = uy2 - ry3;
z(112) = uz2 - rz3;
z(113) = rz1*z(34) - rx1*z(44);
z(114) = z(34)*z(102) + z(39)*z(101) + z(44)*z(99);
z(115) = z(39)*z(100) + z(44)*z(98) - z(34)*z(103);
z(116) = rz1*z(36) - rx1*z(45);
z(117) = z(36)*z(102) + z(41)*z(101) + z(45)*z(99);
z(118) = z(41)*z(100) + z(45)*z(98) - z(36)*z(103);
z(119) = rz1*z(38) - rx1*z(47);
z(120) = z(38)*z(102) + z(43)*z(101) + z(47)*z(99);
z(121) = z(43)*z(100) + z(47)*z(98) - z(38)*z(103);
z(122) = z(20)*z(111) + z(22)*z(110);
z(123) = z(111)*z(39) - z(110)*z(41);
z(124) = z(111)*z(54) - z(110)*z(55);
z(125) = z(111)*z(57) - z(110)*z(58);
z(126) = z(24)*z(110) - z(20)*z(112);
z(127) = z(110)*z(43) - z(112)*z(39);
z(128) = z(110)*z(56) - z(112)*z(54);
z(129) = z(110)*z(59) - z(112)*z(57);
z(130) = -z(22)*z(112) - z(24)*z(111);
z(131) = z(112)*z(41) - z(111)*z(43);
z(132) = z(112)*z(55) - z(111)*z(56);
z(133) = z(112)*z(58) - z(111)*z(59);
z(134) = z(113) + z(131);
z(135) = z(114) + z(132);
z(136) = z(115) + z(133);
z(137) = z(116) + z(127);
z(138) = z(117) + z(128);
z(139) = z(118) + z(129);
z(140) = z(119) + z(123);
z(141) = z(120) + z(124);
z(142) = z(121) + z(125);
z(143) = -rx3*z(22) - ry3*z(20);
z(144) = rx3*z(41) - ry3*z(39);
z(145) = rx3*z(55) - ry3*z(54);
z(146) = rx3*z(58) - ry3*z(57);
z(147) = rz3*z(20) - rx3*z(24);
z(148) = rz3*z(39) - rx3*z(43);
z(149) = rz3*z(54) - rx3*z(56);
z(150) = rz3*z(57) - rx3*z(59);
z(151) = ry3*z(24) + rz3*z(22);
z(152) = ry3*z(43) - rz3*z(41);
z(153) = ry3*z(56) - rz3*z(55);
z(154) = ry3*z(59) - rz3*z(58);
z(155) = z(113) + z(152);
z(156) = z(114) + z(153);
z(157) = z(115) + z(154);
z(158) = z(116) + z(148);
z(159) = z(117) + z(149);
z(160) = z(118) + z(150);
z(161) = z(119) + z(144);
z(162) = z(120) + z(145);
z(163) = z(121) + z(146);
z(164) = uy1*z(64) - ux1*z(65);
z(165) = ux1*z(67) - uz1*z(64);
z(166) = uz1*z(65) - uy1*z(67);
z(167) = z(166) - (z(94)*u5+z(95)*u4)*z(62) - (ux1*u6-z(92)*u5-z(93)*u4)*z(61);
z(168) = z(165) + (uz1*u6+z(96)*u4-z(97)*u5)*z(62) + (ux1*u6-z(92)*u5-z(93)*u4)*z(60);
z(169) = z(164) + (z(94)*u5+z(95)*u4)*z(60) - (uz1*u6+z(96)*u4-z(97)*u5)*z(61);
z(170) = ry1*z(64) - rx1*z(65);
z(171) = rx1*z(67) - rz1*z(64);
z(172) = rz1*z(65) - ry1*z(67);
z(173) = z(172) - (z(100)*u5+z(101)*u4)*z(62) - (rx1*u6-z(98)*u5-z(99)*u4)*z(61);
z(174) = z(171) + (rz1*u6+z(102)*u4-z(103)*u5)*z(62) + (rx1*u6-z(98)*u5-z(99)*u4)*z(60);
z(175) = z(170) + (z(100)*u5+z(101)*u4)*z(60) - (rz1*u6+z(102)*u4-z(103)*u5)*z(61);
z(176) = z(34)*z(173) + z(39)*z(174) + z(44)*z(175);
z(177) = z(36)*z(173) + z(41)*z(174) + z(45)*z(175);
z(178) = z(38)*z(173) + z(43)*z(174) + z(47)*z(175);
z(179) = z(111)*z(77) - z(110)*z(84);
z(180) = z(110)*z(91) - z(112)*z(77);
z(181) = z(112)*z(84) - z(111)*z(91);
z(182) = z(176) + z(181) + (z(122)*u7+z(123)*u6+z(124)*u4+z(125)*u5)*z(69) - (z(126)*u7+z(127)*u6+z(128)*u4+z(129)*u5)*z(70);
z(183) = z(177) + z(180) + (z(130)*u7+z(131)*u6+z(132)*u4+z(133)*u5)*z(70) - (z(122)*u7+z(123)*u6+z(124)*u4+z(125)*u5)*z(68);
z(184) = z(178) + z(179) + (z(126)*u7+z(127)*u6+z(128)*u4+z(129)*u5)*z(68) - (z(130)*u7+z(131)*u6+z(132)*u4+z(133)*u5)*z(69);
z(185) = ec2 - q2;
z(186) = q3 - ec3;
z(187) = ec3 - q3;
z(188) = q1 - ec1;
z(189) = ec1 - q1;
z(190) = q2 - ec2;
z(191) = ec2 + rx3*z(51) + ry3*z(52) + rz3*z(53) - q2 - rx1*z(14) - ry1*z(15) - rz1*z(16);
z(192) = q3 + ry1*z(4) + rz1*z(10) - ec3 - rx1*z(9) - rx3*z(54) - ry3*z(55) - rz3*z(56);
z(193) = ec3 + rx1*z(9) + rx3*z(54) + ry3*z(55) + rz3*z(56) - q3 - ry1*z(4) - rz1*z(10);
z(194) = q1 + rx1*z(11) + rz1*z(13) - ec1 - rx3*z(48) - ry1*z(12) - ry3*z(49) - rz3*z(50);
z(195) = ec1 + rx3*z(48) + ry1*z(12) + ry3*z(49) + rz3*z(50) - q1 - rx1*z(11) - rz1*z(13);
z(196) = q2 + rx1*z(14) + ry1*z(15) + rz1*z(16) - ec2 - rx3*z(51) - ry3*z(52) - rz3*z(53);
z(197) = Grav*mA;
z(198) = Grav*mB;
z(199) = z(11)^2 + z(12)^2 + z(13)^2;
z(200) = z(11)*z(14) + z(13)*z(16) - z(12)*z(15);
z(201) = z(10)*z(13) - z(4)*z(12) - z(9)*z(11);
z(202) = z(48)^2 + z(49)^2 + z(50)^2;
z(203) = z(48)*z(51) + z(49)*z(52) + z(50)*z(53);
z(204) = z(48)*z(54) + z(49)*z(55) + z(50)*z(56);
z(205) = z(197)*(z(12)*z(15)-z(11)*z(14)-z(13)*z(16)) - z(198)*(z(48)*z(51)+z(49)*z(52)+z(50)*z(53));
z(206) = z(14)^2 + z(15)^2 + z(16)^2;
z(207) = z(4)*z(15) + z(10)*z(16) - z(9)*z(14);
z(208) = z(51)^2 + z(52)^2 + z(53)^2;
z(209) = z(51)*z(54) + z(52)*z(55) + z(53)*z(56);
z(210) = -z(197)*(z(14)^2+z(15)^2+z(16)^2) - z(198)*(z(51)^2+z(52)^2+z(53)^2);
z(211) = z(4)^2 + z(9)^2 + z(10)^2;
z(212) = z(54)^2 + z(55)^2 + z(56)^2;
z(213) = z(197)*(z(9)*z(14)-z(4)*z(15)-z(10)*z(16)) - z(198)*(z(51)*z(54)+z(52)*z(55)+z(53)*z(56));
z(214) = z(4)*z(15)*z(187) + z(10)*z(16)*z(187) + z(190)*z(4)^2 + z(190)*z(9)^2 + z(190)*z(10)^2 - z(9)*z(14)*z(187);
z(215) = z(4)*z(15)*z(188) + z(10)*z(13)*z(185) + z(10)*z(16)*z(188) - z(4)*z(12)*z(185) - z(9)*z(11)*z(185) - z(9)*z(14)*z(188);
z(216) = z(10)*z(13)*z(186) + z(189)*z(4)^2 + z(189)*z(9)^2 + z(189)*z(10)^2 - z(4)*z(12)*z(186) - z(9)*z(11)*z(186);
z(217) = z(51)*z(156) + z(52)*z(159) + z(53)*z(162) + z(48)*z(54)*z(192) + z(49)*z(55)*z(192) + z(50)*z(56)*z(192) + z(195)*z(54)^2 + z(195)*z(55)^2 + z(195)*z(56)^2;
z(218) = z(54)*z(156) + z(55)*z(159) + z(56)*z(162) + z(48)*z(54)*z(191) + z(49)*z(55)*z(191) + z(50)*z(56)*z(191) + z(51)*z(54)*z(194) + z(52)*z(55)*z(194) + z(53)*z(56)*z(194);
z(219) = z(48)*z(156) + z(49)*z(159) + z(50)*z(162) + z(51)*z(54)*z(193) + z(52)*z(55)*z(193) + z(53)*z(56)*z(193) + z(196)*z(54)^2 + z(196)*z(55)^2 + z(196)*z(56)^2;
z(220) = z(20)*z(9) + z(20)*z(54) + z(22)*z(4) + z(24)*z(56) - z(22)*z(55) - z(24)*z(10);
z(221) = z(11)*z(108) + z(13)*z(105) - z(12)*z(107);
z(222) = z(14)*z(108) + z(15)*z(107) + z(16)*z(105);
z(223) = z(4)*z(107) + z(10)*z(105) - z(9)*z(108);
z(224) = -z(197)*(z(14)*z(96)+z(15)*z(95)+z(16)*z(93)) - z(198)*(z(51)*z(135)+z(52)*z(138)+z(53)*z(141));
z(225) = z(5)*z(11) + z(6)*z(13);
z(226) = z(5)*z(11)*z(186) + z(6)*z(10)*z(189) + z(6)*z(13)*z(186) - z(5)*z(9)*z(189);
z(227) = z(5)*z(11)*z(185) + z(5)*z(14)*z(188) + z(6)*z(13)*z(185) + z(6)*z(16)*z(188);
z(228) = z(5)*z(14) + z(6)*z(16);
z(229) = z(5)*z(14)*z(187) + z(6)*z(10)*z(190) + z(6)*z(16)*z(187) - z(5)*z(9)*z(190);
z(230) = z(6)*z(10) - z(5)*z(9);
z(231) = z(48)*z(57) + z(49)*z(58) + z(50)*z(59);
z(232) = z(51)*z(157) + z(52)*z(160) + z(53)*z(163) + z(48)*z(57)*z(192) + z(49)*z(58)*z(192) + z(50)*z(59)*z(192) + z(54)*z(57)*z(195) + z(55)*z(58)*z(195) + z(56)*z(59)*z(195);
z(233) = z(54)*z(157) + z(55)*z(160) + z(56)*z(163) + z(48)*z(57)*z(191) + z(49)*z(58)*z(191) + z(50)*z(59)*z(191) + z(51)*z(57)*z(194) + z(52)*z(58)*z(194) + z(53)*z(59)*z(194);
z(234) = z(51)*z(57) + z(52)*z(58) + z(53)*z(59);
z(235) = z(48)*z(157) + z(49)*z(160) + z(50)*z(163) + z(51)*z(57)*z(193) + z(52)*z(58)*z(193) + z(53)*z(59)*z(193) + z(54)*z(57)*z(196) + z(55)*z(58)*z(196) + z(56)*z(59)*z(196);
z(236) = z(54)*z(57) + z(55)*z(58) + z(56)*z(59);
z(237) = z(20)*z(57) + z(24)*z(59) - z(20)*z(5) - z(22)*z(58) - z(24)*z(6);
z(238) = z(13)*z(104) - z(11)*z(109) - z(12)*z(106);
z(239) = z(15)*z(106) + z(16)*z(104) - z(14)*z(109);
z(240) = z(4)*z(106) + z(9)*z(109) + z(10)*z(104);
z(241) = z(197)*(z(14)*z(97)-z(15)*z(94)-z(16)*z(92)) - z(198)*(z(51)*z(136)+z(52)*z(139)+z(53)*z(142));
z(242) = z(4)*z(190) + z(15)*z(187);
z(243) = z(4)*z(189) - z(12)*z(186);
z(244) = z(15)*z(188) - z(12)*z(185);
z(245) = z(39)*z(48) + z(41)*z(49) + z(43)*z(50);
z(246) = z(51)*z(155) + z(52)*z(158) + z(53)*z(161) + z(39)*z(48)*z(192) + z(39)*z(54)*z(195) + z(41)*z(49)*z(192) + z(41)*z(55)*z(195) + z(43)*z(50)*z(192) + z(43)*z(56)*z(195);
z(247) = z(54)*z(155) + z(55)*z(158) + z(56)*z(161) + z(39)*z(48)*z(191) + z(39)*z(51)*z(194) + z(41)*z(49)*z(191) + z(41)*z(52)*z(194) + z(43)*z(50)*z(191) + z(43)*z(53)*z(194);
z(248) = z(39)*z(51) + z(41)*z(52) + z(43)*z(53);
z(249) = z(48)*z(155) + z(49)*z(158) + z(50)*z(161) + z(39)*z(51)*z(193) + z(39)*z(54)*z(196) + z(41)*z(52)*z(193) + z(41)*z(55)*z(196) + z(43)*z(53)*z(193) + z(43)*z(56)*z(196);
z(250) = z(39)*z(54) + z(41)*z(55) + z(43)*z(56);
z(251) = z(22) + z(20)*z(39) + z(24)*z(43) - z(22)*z(41);
z(252) = rz2*z(11) - rx2*z(13);
z(253) = rz2*z(14) - rx2*z(16);
z(254) = -rx2*z(10) - rz2*z(9);
z(255) = z(197)*(ux1*z(16)-uz1*z(14)) - z(198)*(z(51)*z(134)+z(52)*z(137)+z(53)*z(140));
z(256) = z(20)*z(48) + z(24)*z(50) - z(22)*z(49);
z(257) = z(143)*z(53) + z(147)*z(52) + z(151)*z(51) + z(20)*z(48)*z(192) + z(20)*z(54)*z(195) + z(24)*z(50)*z(192) + z(24)*z(56)*z(195) - z(22)*z(49)*z(192) - z(22)*z(55)*z(195);
z(258) = z(143)*z(56) + z(147)*z(55) + z(151)*z(54) + z(20)*z(48)*z(191) + z(20)*z(51)*z(194) + z(24)*z(50)*z(191) + z(24)*z(53)*z(194) - z(22)*z(49)*z(191) - z(22)*z(52)*z(194);
z(259) = z(20)*z(51) + z(24)*z(53) - z(22)*z(52);
z(260) = z(143)*z(50) + z(147)*z(49) + z(151)*z(48) + z(20)*z(51)*z(193) + z(20)*z(54)*z(196) + z(24)*z(53)*z(193) + z(24)*z(56)*z(196) - z(22)*z(52)*z(193) - z(22)*z(55)*z(196);
z(261) = z(20)*z(54) + z(24)*z(56) - z(22)*z(55);
z(262) = z(20)^2 + z(22)^2 + z(24)^2;
z(263) = z(198)*(z(122)*z(53)+z(126)*z(52)+z(130)*z(51));
z(264) = IA1*z(60);
z(265) = IA2*z(61);
z(266) = IA3*z(62);
z(267) = IA1*z(5);
z(268) = IA1*z(9);
z(269) = IA1*z(64);
z(270) = IA2*z(4);
z(271) = IA2*z(65);
z(272) = IA3*z(6);
z(273) = IA3*z(10);
z(274) = IA3*z(67);
z(275) = z(60)*z(265) - z(61)*z(264);
z(276) = z(62)*z(264) - z(60)*z(266);
z(277) = z(61)*z(266) - z(62)*z(265);
z(278) = IB1*z(68);
z(279) = IB2*z(69);
z(280) = IB3*z(70);
z(281) = IB1*z(20);
z(282) = IB1*z(39);
z(283) = IB1*z(54);
z(284) = IB1*z(57);
z(285) = IB1*z(77);
z(286) = IB2*z(41);
z(287) = IB2*z(55);
z(288) = IB2*z(58);
z(289) = IB2*z(22);
z(290) = IB2*z(84);
z(291) = IB3*z(24);
z(292) = IB3*z(43);
z(293) = IB3*z(56);
z(294) = IB3*z(59);
z(295) = IB3*z(91);
z(296) = z(68)*z(279) - z(69)*z(278);
z(297) = z(70)*z(278) - z(68)*z(280);
z(298) = z(69)*z(280) - z(70)*z(279);
z(299) = mB*(z(48)*z(134)+z(49)*z(137)+z(50)*z(140)) - mA*(ux1*z(13)-uz1*z(11));
z(300) = mA*(z(11)^2+z(12)^2+z(13)^2) + mB*(z(48)^2+z(49)^2+z(50)^2);
z(301) = mB*(z(48)*z(51)+z(49)*z(52)+z(50)*z(53)) - mA*(z(12)*z(15)-z(11)*z(14)-z(13)*z(16));
z(302) = mB*(z(48)*z(135)+z(49)*z(138)+z(50)*z(141)) - mA*(z(12)*z(95)-z(11)*z(96)-z(13)*z(93));
z(303) = mB*(z(48)*z(54)+z(49)*z(55)+z(50)*z(56)) - mA*(z(4)*z(12)+z(9)*z(11)-z(10)*z(13));
z(304) = mB*(z(48)*z(136)+z(49)*z(139)+z(50)*z(142)) - mA*(z(11)*z(97)+z(12)*z(94)-z(13)*z(92));
z(305) = mB*(z(122)*z(50)+z(126)*z(49)+z(130)*z(48));
z(306) = mB*(z(48)*z(182)+z(49)*z(183)+z(50)*z(184)) - mA*(z(12)*z(168)-z(11)*z(167)-z(13)*z(169));
z(307) = mB*(z(51)*z(134)+z(52)*z(137)+z(53)*z(140)) - mA*(ux1*z(16)-uz1*z(14));
z(308) = mA*(z(14)^2+z(15)^2+z(16)^2) + mB*(z(51)^2+z(52)^2+z(53)^2);
z(309) = mA*(z(14)*z(96)+z(15)*z(95)+z(16)*z(93)) + mB*(z(51)*z(135)+z(52)*z(138)+z(53)*z(141));
z(310) = mB*(z(51)*z(54)+z(52)*z(55)+z(53)*z(56)) - mA*(z(9)*z(14)-z(4)*z(15)-z(10)*z(16));
z(311) = mB*(z(51)*z(136)+z(52)*z(139)+z(53)*z(142)) - mA*(z(14)*z(97)-z(15)*z(94)-z(16)*z(92));
z(312) = mB*(z(122)*z(53)+z(126)*z(52)+z(130)*z(51));
z(313) = mA*(z(14)*z(167)+z(15)*z(168)+z(16)*z(169)) + mB*(z(51)*z(182)+z(52)*z(183)+z(53)*z(184));
z(314) = mB*(z(54)*z(134)+z(55)*z(137)+z(56)*z(140)) - mA*(ux1*z(10)+uz1*z(9));
z(315) = mB*(z(54)*z(135)+z(55)*z(138)+z(56)*z(141)) - mA*(z(9)*z(96)-z(4)*z(95)-z(10)*z(93));
z(316) = mA*(z(4)^2+z(9)^2+z(10)^2) + mB*(z(54)^2+z(55)^2+z(56)^2);
z(317) = mA*(z(4)*z(94)+z(9)*z(97)+z(10)*z(92)) + mB*(z(54)*z(136)+z(55)*z(139)+z(56)*z(142));
z(318) = mB*(z(122)*z(56)+z(126)*z(55)+z(130)*z(54));
z(319) = mB*(z(54)*z(182)+z(55)*z(183)+z(56)*z(184)) - mA*(z(9)*z(167)-z(4)*z(168)-z(10)*z(169));
z(320) = IA2*z(4) + z(54)*z(282) + z(55)*z(286) + z(56)*z(292) + mB*(z(134)*z(135)+z(137)*z(138)+z(140)*z(141)) - mA*(ux1*z(93)-uz1*z(96));
z(321) = z(4)*z(270) + z(9)*z(268) + z(10)*z(273) + z(54)*z(283) + z(55)*z(287) + z(56)*z(293) + mA*(z(93)^2+z(95)^2+z(96)^2) + mB*(z(135)^2+z(138)^2+z(141)^2);
z(322) = z(10)*z(272) + z(54)*z(284) + z(55)*z(288) + z(56)*z(294) + mB*(z(135)*z(136)+z(138)*z(139)+z(141)*z(142)) + mA*(z(92)*z(93)+z(94)*z(95)-z(96)*z(97)) - z(9)*z(267);
z(323) = z(281)*z(54) + z(291)*z(56) + mB*(z(122)*z(141)+z(126)*z(138)+z(130)*z(135)) - z(289)*z(55);
z(324) = z(4)*z(271) + z(4)*z(276) + z(10)*z(274) + z(10)*z(275) + z(54)*z(285) + z(54)*z(298) + z(55)*z(290) + z(55)*z(297) + z(56)*z(295) + z(56)*z(296) + mA*(z(93)*z(169)+z(95)*z(168)+z(96)*z(167)) + mB*(z(135)*z(182)+z(138)*z(183)+z(141)*z(184)) - z(9)*z(269) - z(9)*z(277);
z(325) = z(5)*z(267) + z(6)*z(272) + z(57)*z(284) + z(58)*z(288) + z(59)*z(294) + mA*(z(92)^2+z(94)^2+z(97)^2) + mB*(z(136)^2+z(139)^2+z(142)^2);
z(326) = z(6)*z(273) + z(57)*z(283) + z(58)*z(287) + z(59)*z(293) + mB*(z(135)*z(136)+z(138)*z(139)+z(141)*z(142)) + mA*(z(92)*z(93)+z(94)*z(95)-z(96)*z(97)) - z(5)*z(268);
z(327) = z(281)*z(57) + z(291)*z(59) + mB*(z(122)*z(142)+z(126)*z(139)+z(130)*z(136)) - z(289)*z(58);
z(328) = z(57)*z(282) + z(58)*z(286) + z(59)*z(292) + mB*(z(134)*z(136)+z(137)*z(139)+z(140)*z(142)) - mA*(ux1*z(92)+uz1*z(97));
z(329) = z(5)*z(269) + z(5)*z(277) + z(6)*z(274) + z(6)*z(275) + z(57)*z(285) + z(57)*z(298) + z(58)*z(290) + z(58)*z(297) + z(59)*z(295) + z(59)*z(296) + mB*(z(136)*z(182)+z(139)*z(183)+z(142)*z(184)) + mA*(z(92)*z(169)+z(94)*z(168)-z(97)*z(167));
z(330) = IA2 + mA*(ux1^2+uz1^2);
z(331) = z(330) + z(39)*z(282) + z(41)*z(286) + z(43)*z(292) + mB*(z(134)^2+z(137)^2+z(140)^2);
z(332) = z(270) + z(39)*z(283) + z(41)*z(287) + z(43)*z(293) + mB*(z(134)*z(135)+z(137)*z(138)+z(140)*z(141)) - mA*(ux1*z(93)-uz1*z(96));
z(333) = z(281)*z(39) + z(291)*z(43) + mB*(z(122)*z(140)+z(126)*z(137)+z(130)*z(134)) - z(289)*z(41);
z(334) = z(39)*z(284) + z(41)*z(288) + z(43)*z(294) + mB*(z(134)*z(136)+z(137)*z(139)+z(140)*z(142)) - mA*(ux1*z(92)+uz1*z(97));
z(335) = z(271) + z(276) + z(39)*z(285) + z(39)*z(298) + z(41)*z(290) + z(41)*z(297) + z(43)*z(295) + z(43)*z(296) + mB*(z(134)*z(182)+z(137)*z(183)+z(140)*z(184)) - mA*(ux1*z(169)-uz1*z(167));
z(336) = z(20)*z(281) + z(22)*z(289) + z(24)*z(291) + mB*(z(122)^2+z(126)^2+z(130)^2);
z(337) = z(20)*z(282) + z(24)*z(292) + mB*(z(122)*z(140)+z(126)*z(137)+z(130)*z(134)) - z(22)*z(286);
z(338) = z(20)*z(283) + z(24)*z(293) + mB*(z(122)*z(141)+z(126)*z(138)+z(130)*z(135)) - z(22)*z(287);
z(339) = z(20)*z(284) + z(24)*z(294) + mB*(z(122)*z(142)+z(126)*z(139)+z(130)*z(136)) - z(22)*z(288);
z(340) = z(20)*z(285) + z(20)*z(298) + z(24)*z(295) + z(24)*z(296) + mB*(z(122)*z(184)+z(126)*z(183)+z(130)*z(182)) - z(22)*z(290) - z(22)*z(297);

Amat(1,1) = z(199);
Amat(1,2) = z(200);
Amat(1,3) = z(201);
Amat(1,4) = 0;
Amat(1,5) = 0;
Amat(1,6) = 0;
Amat(1,7) = 0;
Amat(2,1) = z(200);
Amat(2,2) = z(206);
Amat(2,3) = z(207);
Amat(2,4) = 0;
Amat(2,5) = 0;
Amat(2,6) = 0;
Amat(2,7) = 0;
Amat(3,1) = z(201);
Amat(3,2) = z(207);
Amat(3,3) = z(211);
Amat(3,4) = 0;
Amat(3,5) = 0;
Amat(3,6) = 0;
Amat(3,7) = 0;
Amat(4,1) = z(221);
Amat(4,2) = z(222);
Amat(4,3) = z(223);
Amat(4,4) = z(201);
Amat(4,5) = z(207);
Amat(4,6) = z(211);
Amat(4,7) = z(220);
Amat(5,1) = z(238);
Amat(5,2) = z(239);
Amat(5,3) = z(240);
Amat(5,4) = z(225);
Amat(5,5) = z(228);
Amat(5,6) = z(230);
Amat(5,7) = z(237);
Amat(6,1) = z(252);
Amat(6,2) = z(253);
Amat(6,3) = z(254);
Amat(6,4) = -z(12);
Amat(6,5) = z(15);
Amat(6,6) = z(4);
Amat(6,7) = z(251);
Amat(7,1) = 0;
Amat(7,2) = 0;
Amat(7,3) = 0;
Amat(7,4) = 0;
Amat(7,5) = 0;
Amat(7,6) = 0;
Amat(7,7) = z(262);
bvec(1) = z(306) + z(299)*u6p + z(300)*u1p + z(301)*u2p + z(302)*u4p + z(303)*u3p + z(304)*u5p + z(305)*u7p - FGA1 - z(205) - FGB1*z(202) - FGB2*z(203) - FGB3*z(204);
bvec(2) = z(313) + z(301)*u1p + z(307)*u6p + z(308)*u2p + z(309)*u4p + z(310)*u3p + z(311)*u5p + z(312)*u7p - FGA2 - z(210) - FGB1*z(203) - FGB2*z(208) - FGB3*z(209);
bvec(3) = z(319) + z(303)*u1p + z(310)*u2p + z(314)*u6p + z(315)*u4p + z(316)*u3p + z(317)*u5p + z(318)*u7p - FGA3 - z(213) - FGB1*z(204) - FGB2*z(209) - FGB3*z(212);
bvec(4) = z(324) + z(302)*u1p + z(309)*u2p + z(315)*u3p + z(320)*u6p + z(321)*u4p + z(322)*u5p + z(323)*u7p - z(224) - FGA1*z(214) - FGA2*z(216) - FGA3*z(215) - FGB1*z(219) - FGB2*z(217) - FGB3*z(218) - TGA1*z(201) - TGA2*z(207) - TGA3*z(211) - TGB1*z(204) - TGB2*z(209) - TGB3*z(212);
bvec(5) = z(329) + z(304)*u1p + z(311)*u2p + z(317)*u3p + z(325)*u5p + z(326)*u4p + z(327)*u7p + z(328)*u6p - z(241) - FGA1*z(229) - FGA2*z(226) - FGA3*z(227) - FGB1*z(235) - FGB2*z(232) - FGB3*z(233) - TGA1*z(225) - TGA2*z(228) - TGA3*z(230) - TGB1*z(231) - TGB2*z(234) - TGB3*z(236);
bvec(6) = TGA1*z(12) + z(335) + z(299)*u1p + z(307)*u2p + z(314)*u3p + z(331)*u6p + z(332)*u4p + z(333)*u7p + z(334)*u5p - z(255) - FGA1*z(242) - FGA2*z(243) - FGA3*z(244) - FGB1*z(249) - FGB2*z(246) - FGB3*z(247) - TGA2*z(15) - TGA3*z(4) - TGB1*z(245) - TGB2*z(248) - TGB3*z(250);
bvec(7) = z(263) + z(340) + z(336)*u7p + z(305)*u1p + z(312)*u2p + z(318)*u3p + z(337)*u6p + z(338)*u4p + z(339)*u5p - FGB1*z(260) - FGB2*z(257) - FGB3*z(258) - TGB1*z(256) - TGB2*z(259) - TGB3*z(261);

forces = Amat\bvec;
