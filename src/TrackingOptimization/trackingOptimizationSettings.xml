<?xml version="1.0" encoding="UTF-8" ?>
<OpenSimDocument Version="40000">
    <MuscleTendonPersonalizationTool>
        <!--Directory used for writing results.-->
        <results_directory>\\smb.rdf.rice.edu\research\bjf5\RCNL\SharedData\Projects\Di2Ma\MTP_testing_folder\MTP_Patient4_Data\mtpResults</results_directory>
        <!--Directory for input files-->
        <input_directory>preprocessed</input_directory>
        <!--Name of the input model file (.osim) to use-->
        <input_model_file>optModel_MuscleGroups_LeftMusclesActive_NewSynx.osim</input_model_file>
		<!--Boolean (true, false) indicating if precalibration should be performed before muscle tendon personalization-->
        <perform_precalibration>true</perform_precalibration>
		<!--Boolean (true, false) indicating if delay values should be found individually for each muscle or all together-->
		<muscle_specific_electromechanical_delays>false</muscle_specific_electromechanical_delays>
		<!--Boolean (true, false) indicating if time activation constant values should be found individually for each muscle or all together-->
        <muscle_specific_activation_time_constant>false</muscle_specific_activation_time_constant>																				  
        <!--The set of <MuscleTendonPersonalizationTask> to be completed by the tool, each Task is a separate optimization-->
        <MuscleTendonPersonalizationTaskList>
            <MuscleTendonPersonalizationTask>
                <!--Flag indicating whether or not the task is enabled.-->
                <is_enabled>true</is_enabled>
                <!--Boolean (true, false) indicating if electromechanical delays should be optimized for this task-->
                <optimize_electromechanical_delays>true</optimize_electromechanical_delays>
                <!--Boolean (true, false) indicating if activation time constants should be optimized for this task-->
                <optimize_activation_time_constants>true</optimize_activation_time_constants>
                <!--Boolean (true, false) indicating if activation nonlinearity constants should be optimized for this task-->
                <optimize_activation_nonlinearity_constants>true</optimize_activation_nonlinearity_constants>
                <!--Boolean (true, false) indicating if EMG scale factors should be optimized for this task-->
                <optimize_emg_scale_factors>true</optimize_emg_scale_factors>
                <!--Boolean (true, false) indicating if electromechanical delays should be optimized for this task-->
                <optimize_optimal_fiber_lengths>true</optimize_optimal_fiber_lengths>
                <!--Boolean (true, false) indicating if electromechanical delays should be optimized for this task-->
                <optimize_tendon_slack_lengths>true</optimize_tendon_slack_lengths>
				<!--Boolean (true, false) indicating if synergy extrapolation should be performed during this task-->
                <perform_synergy_extrapolation>true</perform_synergy_extrapolation>
            </MuscleTendonPersonalizationTask>
        </MuscleTendonPersonalizationTaskList>
        <MuscleTendonCostFunctionTerms>
            <!--*Optional* Inverse dynamic joint moments -->
            <IndividualMuscles>
                <InverseDynamicJointMoments>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>2</max_allowable_error>
                </InverseDynamicJointMoments>
                <ActivationTimeConstant>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.02</max_allowable_error>
                    <!--Reference value relative to which errors are calculated-->
                    <error_center>0.015</error_center>
                </ActivationTimeConstant>
                <ActivationNonlinearityConstant>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </ActivationNonlinearityConstant>
                <OptimalMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </OptimalMuscleFiberLength>
                <TendonSlackLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </TendonSlackLength>
                <EmgScalingFactors>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.2</max_allowable_error>
                    <!--Reference value relative to which errors are calculated-->
                    <error_center>0.3</error_center>
                </EmgScalingFactors>
                <NormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </NormalizedMuscleFiberLength>
                <PassiveMuscleForces>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>50</max_allowable_error>
                </PassiveMuscleForces>
            </IndividualMuscles>
            <PairedMuscles>
                <NormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.05</max_allowable_error>
                </NormalizedMuscleFiberLength>
                <EmgScalingFactors>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </EmgScalingFactors>
                <ElectromechanicalDelay>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.2</max_allowable_error>
                    <!--Boolean (true, false) indicating if delay values should be found individually for each muscle or all together-->
                    <muscle_specific_electromechanical_delays>false</muscle_specific_electromechanical_delays>
                </ElectromechanicalDelay>
            </PairedMuscles>
			<SynergyExtrapolationSettings>
				<!--Specify the matrix factorization approach for MSA; PCA or NMF.-->
				<matrix_factorization_method>PCA</matrix_factorization_method>
				<!--Indicate the number of synergies for synergy extrapolation.-->
				<number_of_synergies>5</number_of_synergies>
				<!--Indicate categorization of variability for synergy extrapolation: Task, Trial, or Subject.-->
				<synergy_extrapolation_categorization>trial</synergy_extrapolation_categorization>
				<!--Indicate categorization of variability for muscle activation residuals: Task, Trial, or Subject.-->
				<residual_categorization>task</residual_categorization>
                <MeasuredInverseDynamicJointMoments>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>2.5</max_allowable_error>
                </MeasuredInverseDynamicJointMoments>
                <ExtrapolatedMuscleActivations>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.3</max_allowable_error>
                </ExtrapolatedMuscleActivations>
                <ResidualMuscleActivations>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.3</max_allowable_error>
                </ResidualMuscleActivations>
			</SynergyExtrapolationSettings>  
        </MuscleTendonCostFunctionTerms>
		<PreCalibrationSettings>
			<passive_data_input_directory>thelen</passive_data_input_directory>
            <passive_trial_prefixes>Thelen_HipPassive_01 Thelen_HipPassive_02 Thelen_HipPassive_03 Thelen_HipPassive_04 Thelen_KneePassive_01 Thelen_KneePassive_02 Thelen_KneePassive_03 Thelen_KneePassive_04 Thelen_AnklePassive_01 Thelen_AnklePassive_02 Thelen_AnklePassive_03 Thelen_AnklePassive_04</passive_trial_prefixes>
			<max_normalized_muscle_fiber_length>1</max_normalized_muscle_fiber_length>
			<min_normalized_muscle_fiber_length>0.6</min_normalized_muscle_fiber_length>
            <optimize_maximum_muscle_stress>true</optimize_maximum_muscle_stress>
            <optimize_isometric_max_force>true</optimize_isometric_max_force>
		</PreCalibrationSettings>
		<PreCalibrationCostFunctionTerms>
            <IndividualMuscles>
                <PassiveJointMoments>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>2</max_allowable_error>
                </PassiveJointMoments>
                <OptimalMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.3</max_allowable_error>
					<!--Reference value relative to which errors are calculated-->
                    <error_center>1</error_center>
                </OptimalMuscleFiberLength>
                <TendonSlackLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>1</max_allowable_error>
					<!--Reference value relative to which errors are calculated-->
                    <error_center>1</error_center>
                </TendonSlackLength>
                <MinimumNormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.3</max_allowable_error>
                </MinimumNormalizedMuscleFiberLength>
				<MaximumNormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.03</max_allowable_error>
                </MaximumNormalizedMuscleFiberLength>
                <MaximumMuscleStress>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
					<!--Reference value relative to which errors are calculated-->
                    <error_center>1.2</error_center>
                </MaximumMuscleStress>
                <PassiveMuscleForces>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>10</max_allowable_error>
                </PassiveMuscleForces>
            </IndividualMuscles>
            <PairedMuscles>
                <NormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </NormalizedMuscleFiberLength>
                <MaximumNormalizedMuscleFiberLength>
                    <!--Flag indicating whether or not the term is enabled in the cost function.-->
                    <is_enabled>true</is_enabled>
                    <!--Max allowable error or deviation from indicated set point-->
                    <max_allowable_error>0.1</max_allowable_error>
                </MaximumNormalizedMuscleFiberLength>				
            </PairedMuscles>
        </PreCalibrationCostFunctionTerms>
        <PairedMuscles>
            <PairedActivationTimeConstants>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>AdductorActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMaxActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMedActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMinActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>IliopsoasActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>HamstringActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>BicepsFemActivationGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>PeroneusActivationGroupL</musclepairs>
            </PairedActivationTimeConstants>
            <PairedNormalizedMuscleFiberLengths>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>AdductorFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMaxFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMedFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GluteusMinFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>QuadricepFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>HamstringFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>PeroneusFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>IliopsoasFiberLengthGroupL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>GastrocFiberLengthGroupL</musclepairs>
				<!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>TibialisAnteriorFiberLengthGroupL</musclepairs>
				<!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>TibialisPosteriorFiberLengthGroupL</musclepairs>
            </PairedNormalizedMuscleFiberLengths>
			<PairedMissingEmgChannels>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>AddLongMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>ExtDigLongMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>FlexDigLongMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>IliopsoasMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>PeroneusLongMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>RecFemMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>TibPostMissingEmgChannelL</musclepairs>
                <!--Name of muscle group defined in the <group> element in the ForceSet of the .osim file-->
                <musclepairs>VastMedMissingEmgChannelL</musclepairs>
            </PairedMissingEmgChannels>
        </PairedMuscles> 
        <!--*Optional* The vMaxFactor to use-->
        <v_max_factor>10</v_max_factor>
		<!--*Optional* The muscle specific tension to use-->
        <maximum_muscle_stress>610e3</maximum_muscle_stress>
        <!--*Optional* The number of allowed iterations of the fmincon optimization, setting this lower can help cancel an optimization that won't converge-->
        <max_iterations>2e3</max_iterations>
        <!--*Optional* The number of allowed cost function calls for the fmincon optimization, setting this lower can help cancel an optimization that won't converge-->
        <max_function_evaluations>1e8</max_function_evaluations>
        <!--*Optional* space-separated list of prefixes to use for data files, if left blank, use all prefixes fron IK folder-->
        <trial_prefixes>speed1_gait_1 speed1_gait_2 speed2_squat_1 speed2_squat_2</trial_prefixes>
        <!--*Optional* space-separated list of prefixes that indicate different speeds or tasks, one speed or task will be assumed for all trials-->
        <task_prefixes>speed1 speed2</task_prefixes>
    </MuscleTendonPersonalizationTool>
</OpenSimDocument>